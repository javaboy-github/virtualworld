<!DOCTYPE html>
<html>
    <head>
        <link href="style.css" rel="stylesheet">
    </head>
    <body>
        <div id="img_area">
            <canvas id="imgOut" style="image-rendering: pixelated;"></canvas>
        </div>
        <a href="/" id="top">top</a>
    </body>
</html>
<script src="3d.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();

function _getp(a,b,c,d,p) {
    let a1 = (p[0]-a[0])*(p[1]-a[1]);let a2 = (p[0]-b[0])*(b[1]-p[1]);
    let a3 = (c[0]-p[0])*(c[1]-p[1]);let a4 = (d[0]-p[0])*(p[1]-d[1]);
    return (a[2]*a1+b[2]*a2+c[2]*a3+d[2]*a4);
}
function getp(p,s=1) {
    let minx = Math.floor(p[0]/(2**s))*(2**s);let maxx = minx+(2**s);
    let miny = Math.floor(p[1]/(2**s))*(2**s);let maxy = miny+(2**s);
    let res = _getp([0,0,test8(minx,miny)],[0,1,test8(minx,maxy)],[1,1,test8(maxx,maxy)],[1,0,test8(maxx,miny)],[(p[0]-minx)/2**s,(p[1]-miny)/2**s]);
    res = _getp([0,0,test8(maxx,miny)],[0,1,test8(maxx,maxy)],[1,1,test8(minx,maxy)],[1,0,test8(minx,miny)],[(p[0]-minx)/2**s,(p[1]-miny)/2**s]);
    res = _getp([0,0,test8(maxx,maxy)],[0,1,test8(maxx,miny)],[1,1,test8(minx,miny)],[1,0,test8(minx,maxy)],[(p[0]-minx)/2**s,(p[1]-miny)/2**s]);
    return res;
}
function height(x,y,max=8,min=0) {
    let res = 0;
    for (let i=min;i<max;i++) {res += getp([x/2,y/2],i)/((max-i+min)*2);}
    return res;
}

function test8(x,y) {
    let v = x*(2**12)+y;
    let base = 500;
    let ret = 0;
    let times = 3;
    for (let i=1;i<=times;i++) {
        ret += ((Math.cos(v*base/i+i)**2))*((i**8));
        i++;
    }
    return Math.abs(ret/times*4+128)%1*40-17;
}

let obj = [];
let color = [255,255,255];
let water = [1,18,200];
for (y=-0;y<200;y+=2) {
    for (x=-200;x<200;x+=2) {
        y_=y;x_=x;
        // 地面
        obj.push([[x_,y_,height(x,y)],[x_,y_-1,height(x,y-1)],[x_+1,y_-1,height(x+1,y-1)],color]);
        obj.push([[x_,y_,height(x,y)],[x_+1,y_-1,height(x+1,y-1)],[x_+1,y_,height(x+1,y)],color]);
        obj.push([[x_,y_,height(x,y)],[x_+1,y_,height(x+1,y)],[x_+1,y_+1,height(x+1,y+1)],color]);
        obj.push([[x_,y_,height(x,y)],[x_+1,y_+1,height(x+1,y+1)],[x_,y_+1,height(x,y+1)],color]);
        obj.push([[x_,y_,height(x,y)],[x_,y_+1,height(x,y+1)],[x_-1,y_+1,height(x-1,y+1)],color]);
        obj.push([[x_,y_,height(x,y)],[x_-1,y_+1,height(x-1,y+1)],[x_-1,y_,height(x-1,y)],color]);
        obj.push([[x_,y_,height(x,y)],[x_-1,y_,height(x-1,y)],[x_-1,y_-1,height(x-1,y-1)],color]);
        obj.push([[x_,y_,height(x,y)],[x_-1,y_-1,height(x-1,y-1)],[x_,y_-1,height(x,y-1)],color]);
        // 水面
        obj.push([[x_-1,y_-1,0],[x_+1,y_-1,0],[x_+1,y_+1,0],water]);
        obj.push([[x_-1,y_-1,0],[x_+1,y_+1,0],[x_-1,y_+1,0],water]);
    }
}

let tddraw = new tdDRAW();
tddraw.setCamera([[0,0,18],[0,0],[1920,1080]]);
tddraw.setCamera([[0,0,1],[0,0],[1920,1080]]);
tddraw.setCamera([[0,100,170],[0,-90],[1920,1080]]);
tddraw.setObj(obj);
var co = document.getElementById("imgOut");
var ctx = co.getContext('2d');
co.height=tddraw.display[1];co.width=tddraw.display[0];

let img = tddraw.getImg();
ctx.putImageData(img,0,0);

</script>
<script>
// resize window
function resizeImg() {
        dw = tddraw.display[0];
        dh = tddraw.display[1];
        let bottom_area = 0;
        let rw = 0;let rh = 0;
        let ww = window.innerWidth;
        let wh = window.innerHeight-bottom_area;
        let csc = 1
        hcsc = ww/dw; wcsc = wh/dh;
        if (hcsc>wcsc) {
            csc = wcsc; rw = (ww - dw*csc)/2;
        }
        else {
            csc = hcsc; rh = (wh - dh*csc)/2;
        }
        document.getElementById("imgOut").style.marginTop = (rh).toString()+"px";
        document.getElementById("imgOut").style.marginBottom = (rh).toString()+"px";
        document.getElementById("imgOut").style.marginLeft = (rw).toString()+"px";
        document.getElementById("imgOut").style.marginRight = (rw).toString()+"px";
        document.getElementById("imgOut").style.transform = "scale("+csc.toString()+","+csc.toString()+")";
    };
window.onresize = resizeImg;
resizeImg(); // first resize
</script>
<style>
    body {
        overflow: hidden;
    }
    #top {
        position: absolute;
        bottom: 0;
        left: 0;
    }
    #imgOut {
        position: absolute;
        left: 0;
        top: 0;
        transform-origin: top left;
    }
</style>